---
# tasks/vault_upload_1password.yml â€” Store passphrase in 1Password
# Requires: op CLI installed and authenticated (user session or OP_SERVICE_ACCOUNT_TOKEN)

- name: Verify 1Password CLI is installed
  ansible.builtin.command:
    cmd: op --version
  delegate_to: localhost
  become: false
  register: _op_version
  changed_when: false
  failed_when: _op_version.rc != 0

- name: Set item title for 1Password
  ansible.builtin.set_fact:
    _op_item_title: "{{ luks_rotation_vault_title_template }}"

- name: Build 1Password environment
  ansible.builtin.set_fact:
    _op_env: "{{ {'OP_SERVICE_ACCOUNT_TOKEN': lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN')}
                 if lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') | length > 0
                 else {} }}"

- name: Search for existing item in 1Password vault
  ansible.builtin.shell:
    cmd: >
      set -o pipefail &&
      op item list
      --vault "{{ luks_rotation_1password_vault }}"
      --format json
      | jq -r '.[] | select(.title == "{{ _op_item_title }}") | .id'
    executable: /bin/bash
  delegate_to: localhost
  become: false
  register: _op_search_result
  changed_when: false
  failed_when: false
  environment: "{{ _op_env }}"
  no_log: false

- name: Set existing item ID
  ansible.builtin.set_fact:
    _op_item_id: "{{ _op_search_result.stdout | trim }}"

- name: Debug 1Password lookup result
  ansible.builtin.debug:
    msg: "1Password lookup for '{{ _op_item_title }}': {{ 'found ' + _op_item_id if _op_item_id | length > 0 else 'not found, will create' }}"

- name: Update existing password item in 1Password
  ansible.builtin.command:
    cmd: >
      op item edit "{{ _op_item_id }}"
      --vault "{{ luks_rotation_1password_vault }}"
      "password={{ _luks_rotation_new_passphrase }}"
  delegate_to: localhost
  become: false
  register: _op_update_result
  changed_when: _op_update_result.rc == 0
  when: _op_item_id | length > 0
  failed_when: luks_rotation_vault_fail_on_upload_error and _op_update_result.rc != 0
  environment: "{{ _op_env }}"

- name: Create new password item in 1Password
  ansible.builtin.command:
    cmd: >
      op item create
      --category Password
      --vault "{{ luks_rotation_1password_vault }}"
      --title "{{ _op_item_title }}"
      --tags "{{ luks_rotation_1password_tags | join(',') }}"
      --format json
      "password={{ _luks_rotation_new_passphrase }}"
  delegate_to: localhost
  become: false
  register: _op_create_result
  changed_when: _op_create_result.rc == 0
  when: _op_item_id | length == 0
  failed_when: luks_rotation_vault_fail_on_upload_error and _op_create_result.rc != 0
  environment: "{{ _op_env }}"

- name: Look up created item ID
  ansible.builtin.shell:
    cmd: >
      set -o pipefail &&
      op item list
      --vault "{{ luks_rotation_1password_vault }}"
      --format json
      | jq -r '.[] | select(.title == "{{ _op_item_title }}") | .id'
    executable: /bin/bash
  delegate_to: localhost
  become: false
  register: _op_created_lookup
  changed_when: false
  environment: "{{ _op_env }}"
  no_log: false
  when:
    - _op_create_result is not skipped
    - _op_create_result.rc == 0

- name: Set item ID from create lookup
  ansible.builtin.set_fact:
    _op_item_id: "{{ _op_created_lookup.stdout | trim }}"
  when: _op_created_lookup is not skipped

- name: Add metadata fields to 1Password item
  ansible.builtin.command:
    cmd: >
      op item edit "{{ _op_item_id }}"
      --vault "{{ luks_rotation_1password_vault }}"
      "hostname[text]={{ inventory_hostname }}"
      "luks_devices[text]={{ _luks_rotation_device_list | join(',') }}"
      "rotated_date[text]={{ ansible_date_time.iso8601 }}"
  delegate_to: localhost
  become: false
  changed_when: true
  when: (_op_create_result is changed) or (_op_update_result is changed)
  failed_when: false
  environment: "{{ _op_env }}"

- name: Report 1Password upload status
  ansible.builtin.debug:
    msg: >
      1Password {{ 'updated' if _op_update_result is changed
      else ('created' if _op_create_result is changed else 'skipped') }}
      item "{{ _op_item_title }}" for {{ inventory_hostname }}
