---
# tasks/vault_upload_1password.yml â€” Store passphrase in 1Password
# Requires: op CLI installed, OP_SERVICE_ACCOUNT_TOKEN environment variable set

- name: Verify 1Password CLI is installed
  ansible.builtin.command:
    cmd: op --version
  delegate_to: localhost
  become: false
  register: _op_version
  changed_when: false
  failed_when: _op_version.rc != 0

- name: Set item title for 1Password
  ansible.builtin.set_fact:
    _op_item_title: "{{ luks_rotation_vault_title_template }}"

- name: Check if item already exists in 1Password
  ansible.builtin.shell:
    cmd: >
      op item list --vault "{{ luks_rotation_1password_vault }}"
      --categories Password
      --format json | jq -r '.[] | select(.title == "{{ _op_item_title }}") | .id'
  delegate_to: localhost
  become: false
  register: _op_existing_item
  changed_when: false
  failed_when: false
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Create new password item in 1Password
  ansible.builtin.command:
    cmd: >
      op item create
      --category Password
      --vault "{{ luks_rotation_1password_vault }}"
      --title "{{ _op_item_title }}"
      --tags "{{ luks_rotation_1password_tags | join(',') }}"
      "password={{ _luks_rotation_new_passphrase }}"
  delegate_to: localhost
  become: false
  register: _op_create_result
  when: _op_existing_item.stdout == ""
  failed_when: luks_rotation_vault_fail_on_upload_error and _op_create_result.rc != 0
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Update existing password item in 1Password
  ansible.builtin.command:
    cmd: >
      op item edit "{{ _op_existing_item.stdout }}"
      --vault "{{ luks_rotation_1password_vault }}"
      "password={{ _luks_rotation_new_passphrase }}"
  delegate_to: localhost
  become: false
  register: _op_update_result
  when: _op_existing_item.stdout != ""
  failed_when: luks_rotation_vault_fail_on_upload_error and _op_update_result.rc != 0
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Add metadata fields to 1Password item
  ansible.builtin.command:
    cmd: >
      op item edit "{{ _op_existing_item.stdout | default(_op_create_result.stdout) }}"
      --vault "{{ luks_rotation_1password_vault }}"
      "hostname[text]={{ inventory_hostname }}"
      "luks_devices[text]={{ _luks_rotation_device_list | join(',') }}"
      "rotated_date[text]={{ ansible_date_time.iso8601 }}"
  delegate_to: localhost
  become: false
  when: (_op_create_result is changed) or (_op_update_result is changed)
  failed_when: false
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Report 1Password upload status
  ansible.builtin.debug:
    msg: >
      1Password upload {{ 'successful' if (_op_create_result is changed or _op_update_result is changed)
      else 'skipped (no changes)' }} for {{ inventory_hostname }}
