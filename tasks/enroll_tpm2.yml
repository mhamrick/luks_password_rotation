---
# tasks/enroll_tpm2.yml — Enroll TPM2 auto-unlock on LUKS devices
# Runs BEFORE passphrase rotation so the known-good current passphrase is used.

- name: Install TPM2 packages
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  become: true
  loop: "{{ tpm2_package_names }}"

- name: Check systemd-cryptenroll is available
  ansible.builtin.command: systemd-cryptenroll --version
  changed_when: false
  register: _tpm2_cryptenroll_version

- name: Parse systemd version number
  ansible.builtin.set_fact:
    _tpm2_systemd_version: >-
      {{ _tpm2_cryptenroll_version.stdout
         | regex_search('systemd\s+(\d+)', '\1')
         | first }}

- name: Assert systemd >= 248 (TPM2 support)
  ansible.builtin.assert:
    that:
      - _tpm2_systemd_version | int >= 248
    fail_msg: >-
      systemd-cryptenroll TPM2 support requires systemd >= 248.
      Detected version: {{ _tpm2_systemd_version }}

- name: Verify TPM2 device exists
  ansible.builtin.stat:
    path: /dev/tpmrm0
  register: _tpm2_device_stat

- name: Assert TPM2 device is present
  ansible.builtin.assert:
    that:
      - _tpm2_device_stat.stat.exists
    fail_msg: >-
      TPM2 resource manager device /dev/tpmrm0 not found.
      Ensure the TPM2 kernel module is loaded and the device is available.

- name: Write unlock passphrase to secure temp file
  ansible.builtin.copy:
    content: "{{ luks_rotation_current_passphrases[0] }}"
    dest: /run/.luks_unlock_key
    mode: "0600"
    owner: root
  become: true

- name: Wipe existing TPM2 slots and enroll new TPM2 token
  ansible.builtin.command:
    cmd: >-
      systemd-cryptenroll
      --unlock-key-file=/run/.luks_unlock_key
      {% if luks_rotation_tpm2_wipe_existing | bool %}--wipe-slot=tpm2{% endif %}
      --tpm2-device={{ luks_rotation_tpm2_device }}
      --tpm2-pcrs={{ luks_rotation_tpm2_pcrs }}
      {{ item }}
  become: true
  changed_when: true
  loop: "{{ _luks_rotation_device_list }}"
  loop_control:
    label: "{{ item }}"
  register: _tpm2_enroll_result

- name: Remove unlock passphrase temp file
  ansible.builtin.file:
    path: /run/.luks_unlock_key
    state: absent
  become: true

- name: Resolve LUKS device UUIDs for crypttab matching
  ansible.builtin.command: "blkid -s UUID -o value {{ item }}"
  become: true
  changed_when: false
  loop: "{{ _luks_rotation_device_list }}"
  loop_control:
    label: "{{ item }}"
  register: _tpm2_device_uuids

- name: Build UUID list
  ansible.builtin.set_fact:
    _tpm2_uuid_list: "{{ _tpm2_device_uuids.results | map(attribute='stdout') | list }}"

- name: Update /etc/crypttab for TPM2 auto-unlock
  when: luks_rotation_tpm2_update_crypttab | bool
  block:
    - name: Update crypttab — set key field to '-'
      ansible.builtin.replace:
        path: /etc/crypttab
        regexp: '^(\S+\s+UUID={{ item }}\s+)\S+(\s+.*)'
        replace: '\1-\2'
      become: true
      loop: "{{ _tpm2_uuid_list }}"
      loop_control:
        label: "UUID={{ item }} — set key field to -"
      register: _tpm2_crypttab_keyfield

    - name: Update crypttab — add tpm2-device=auto to options
      ansible.builtin.replace:
        path: /etc/crypttab
        regexp: '^(\S+\s+UUID={{ item }}\s+\S+\s+)((?!.*tpm2-device=).*)$'
        replace: '\1\2,tpm2-device={{ luks_rotation_tpm2_device }}'
      become: true
      loop: "{{ _tpm2_uuid_list }}"
      loop_control:
        label: "UUID={{ item }} — add tpm2-device"
      register: _tpm2_crypttab_option

    - name: Clean up leading comma in crypttab options
      ansible.builtin.replace:
        path: /etc/crypttab
        regexp: '(\s),tpm2-device='
        replace: '\1tpm2-device='
      become: true

- name: Regenerate initramfs
  ansible.builtin.command: "{{ tpm2_initramfs_command }}"
  become: true
  changed_when: true
  when:
    - luks_rotation_tpm2_update_initramfs | bool
    - _tpm2_enroll_result is changed or
      (_tpm2_crypttab_keyfield is defined and _tpm2_crypttab_keyfield is changed) or
      (_tpm2_crypttab_option is defined and _tpm2_crypttab_option is changed)

- name: Verify TPM2 enrollment on each device
  ansible.builtin.command: "systemd-cryptenroll {{ item }}"
  become: true
  changed_when: false
  loop: "{{ _luks_rotation_device_list }}"
  loop_control:
    label: "{{ item }}"
  register: _tpm2_enrollment_status

- name: Display TPM2 enrollment status
  ansible.builtin.debug:
    msg: "{{ item.stdout_lines }}"
  loop: "{{ _tpm2_enrollment_status.results }}"
  loop_control:
    label: "{{ item.item }}"
